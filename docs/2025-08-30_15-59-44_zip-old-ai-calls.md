# Zip AI Calls on Startup: Daily Archives (Except Today)

Date: 2025-08-30 15:59:44

## Goals
- On each plugin start, zip AI call logs by day, skipping the current day.
- Backwards compatible with existing file name patterns.
- Minimal startup impact and safe on OneDrive.

## Plan
1. Create `src/zipCalls.ts` exporting `zipOldAiCalls(app?, now?)`.
2. Detect day for each file via filename; fallback to file mtime if unknown.
3. Group files by day (YYYY-MM-DD) excluding today; produce `ai-calls_YYYY-MM-DD.zip`.
4. Use tmp file + atomic rename for the zip, then delete originals with retry.
5. Wire `zipOldAiCalls` into `main.ts` `onload()` so it runs each startup.
6. Add `yazl` as a dependency and minimal types to satisfy TS.

## Viability
- Node + `yazl` supports streaming zip creation with compression.
- Works with OneDrive using tmp + rename and delete retries.
- Backward compatibility handled by parsing both `vault-bot_YYYYMMDD_...` and `vault-bot-local_YYYYMMDD-...`; otherwise use `mtime`.
- No behavior change for recording; archives are additive.

## Execution Log
- 15:59:44 Pulled current time via workspace task (Get-Date).
- 16:00:30 Added `src/zipCalls.ts` with daily grouping, legacy name parsing, tmp/rename, and safe deletes.
- 16:01:05 Wired startup call in `main.ts` `onload()` with try/catch guard.
- 16:01:20 Installed `yazl` and added ambient types `src/types/yazl.d.ts`.
- 16:02:10 Build: PASS (tsc + esbuild).
- 16:02:35 Tests: PASS (75/75).
 - 16:03:10 Added safe zip naming with numeric suffix to avoid overwriting existing archives.
 - 16:09:00 Switched archives to solid 7z per day using 7zip-bin (LZMA2, -mx=9, solid on); keeps zip fallback.
 - 16:09:40 Build: PASS; Tests: PASS (75/75) with 7z changes.

## Quality Gates
- Build: PASS
- Tests: PASS (75/75)
- Lint: Not run

## Requirements coverage
- Zip on startup, excluding today: Done
- Backwards compatible with existing log filenames: Done
- New TS file `src/zipCalls.ts`: Done
- Document plan/viability/progress with current timestamp: Done
 - Use solid compression (7z): Done (with .zip fallback)
